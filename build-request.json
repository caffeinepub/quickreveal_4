{
  "kind": "build_request",
  "title": "NEXUS v8.0 — Full multi-file production platform (Payrexx TWINT, ICP mainnet, Internet Identity)",
  "projectName": "NEXUS Beauty Platform",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-1",
      "text": "Create `frontend/src/lib/payrexx.ts` with the exact implementation provided: `createSubscriptionUrl(proId, email, phone)` and `createBookingUrl(bookingId, montant, serviceName, email)` functions that call the Payrexx API directly from the frontend using `VITE_PAYREXX_INSTANCE` and `VITE_PAYREXX_SECRET` env vars, always passing `psp[0]=twint`, returning the gateway link URL. No Stripe, no Revolut references anywhere.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-2"
        ],
        "quotes": [
          "FRONTEND src/lib/payrexx.ts : Fichier séparé avec vraies fonctions"
        ]
      },
      "acceptanceCriteria": [
        "`createSubscriptionUrl` posts to `https://nexus.payrexx.com/api/v1/Gateway/` with amount=1990, currency=CHF, psp[0]=twint, purpose='Abonnement NEXUS Pro 7j'",
        "`createBookingUrl` posts with Math.round(montant*100) as amount, currency=CHF, psp[0]=twint",
        "Both functions return `data.data?.[0]?.link ?? ''`",
        "Authorization header uses Basic btoa(`${INSTANCE}:${SECRET}`)",
        "No Stripe or Revolut imports or references in any file"
      ]
    },
    {
      "id": "REQ-2",
      "text": "Create `frontend/src/lib/twilio.ts` with `sendOTP(phone)` and `verifyOTP(phone, code)` functions that proxy through `VITE_WORKER_URL` (`/send-otp` and `/verify-otp` endpoints). Credentials are never exposed on the frontend. `verifyOTP` returns `data.valid === true`.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-2"
        ],
        "quotes": [
          "FRONTEND src/lib/twilio.ts : Via Supabase Edge Function ou Cloudflare Worker sécurisé (credentials jamais exposés)"
        ]
      },
      "acceptanceCriteria": [
        "`sendOTP` posts `{ phone }` to `${VITE_WORKER_URL}/send-otp`",
        "`verifyOTP` posts `{ phone, code }` to `${VITE_WORKER_URL}/verify-otp` and returns boolean",
        "No Twilio credentials appear anywhere in frontend source"
      ]
    },
    {
      "id": "REQ-3",
      "text": "Add documented Payrexx HTTP outcall stub in `backend/main.mo` as a block comment titled `PAYREXX_INTEGRATION`, showing the full commented-out `callPayrexx` function using `IC.http_request` for future ICP mainnet HTTP outcalls activation. The stub must be preserved verbatim and never deleted.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-2"
        ],
        "quotes": [
          "CANISTER MOTOKO garde les stubs complets documentés"
        ]
      },
      "acceptanceCriteria": [
        "Comment block `/* PAYREXX_INTEGRATION ... */` exists in main.mo",
        "Stub shows `IC.http_request` call to `https://nexus.payrexx.com/api/v1/Gateway/`",
        "Motoko code compiles successfully with the stub commented out"
      ]
    },
    {
      "id": "REQ-4",
      "text": "Refactor the entire frontend into the exact multi-file architecture specified. Deliver every file listed: `src/App.tsx` (useState routing, ToastContainer, NotifsPanel), `src/state/useAppState.ts` (global state, `go()`, `showToast()`, `update()`), `src/lib/actor.ts` (ICP Internet Identity, createActor, login, logout), `src/lib/api.ts` (all canister functions), `src/lib/notifications.ts` (getNotifications, markRead), `src/styles/globals.css` (CSS vars palette, keyframe animations, mobile reset, scrollbar hidden), and `src/components/icons/index.tsx` (30+ SVG icon components, zero emojis).",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-2"
        ],
        "quotes": [
          "Architecture multi-fichiers. Plus maintenable. Plus professionnel.",
          "Structure exacte à livrer"
        ]
      },
      "acceptanceCriteria": [
        "All files in the specified directory structure exist and are non-empty",
        "`useAppState.ts` exports `go()`, `showToast()`, `update()` and a global state object",
        "`actor.ts` uses Internet Identity (DFINITY AuthClient) for real ICP mainnet authentication",
        "`icons/index.tsx` contains 30+ named SVG components, none use emoji characters",
        "`globals.css` defines CSS custom property palette, hides scrollbars, includes keyframe animations"
      ]
    },
    {
      "id": "REQ-5",
      "text": "Deliver all UI component files under `src/components/ui/`: `BtnPrimary.tsx`, `BtnSecondary.tsx`, `Input.tsx`, `Label.tsx`, `Card.tsx`, `Toast.tsx`, `Header.tsx`, `TabBarClient.tsx`, `TabBarPro.tsx`, `TabBarAdmin.tsx`, `BottomSheet.tsx`, `ProgressCircle.tsx`, `Shimmer.tsx`. Each component must be fully functional with proper TypeScript props, onClick/onChange handlers, and no emojis.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-2"
        ],
        "quotes": [
          "components/ui/ BtnPrimary.tsx BtnSecondary.tsx Input.tsx Label.tsx Card.tsx Toast.tsx Header.tsx TabBarClient.tsx TabBarPro.tsx TabBarAdmin.tsx BottomSheet.tsx ProgressCircle.tsx Shimmer.tsx"
        ]
      },
      "acceptanceCriteria": [
        "All 13 component files exist under `src/components/ui/`",
        "Every button component has an `onClick` prop wired",
        "Every input component has an `onChange` prop wired",
        "No emoji characters in any component file",
        "Gold background elements use `color: #050507` for text"
      ]
    },
    {
      "id": "REQ-6",
      "text": "Deliver all auth screens: `src/screens/auth/LoginScreen.tsx` (Internet Identity login, real ICP mainnet), `src/screens/auth/RoleScreen.tsx` (client / professional / admin role selection), `src/screens/auth/OTPScreen.tsx` (6-digit SMS OTP input verified via `lib/twilio.ts` Cloudflare Worker). All screens must have back navigation and no emoji.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-2"
        ],
        "quotes": [
          "screens/auth/ LoginScreen.tsx RoleScreen.tsx OTPScreen.tsx"
        ]
      },
      "acceptanceCriteria": [
        "LoginScreen uses real Internet Identity via `actor.ts`, no hardcoded credentials",
        "OTPScreen renders 6 individual digit inputs (not 4)",
        "OTPScreen calls `verifyOTP` from `lib/twilio.ts`, not a hardcoded demo code",
        "All screens have a back button with onClick handler"
      ]
    },
    {
      "id": "REQ-7",
      "text": "Deliver all client screens: `ExplorerScreen.tsx`, `FicheProScreen.tsx`, `Booking1Screen.tsx` through `Booking5Screen.tsx` (5-step booking flow), `LiveStatusScreen.tsx`, `ReservationsScreen.tsx`, `AlertesScreen.tsx`, `ClientProfilScreen.tsx`. All screens use `go()` from `useAppState` for navigation. Booking confirmation must call `createBookingUrl` from `lib/payrexx.ts` and redirect via `window.location.href` to the Payrexx TWINT gateway. No setTimeout fake payment flows.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-2"
        ],
        "quotes": [
          "screens/client/ ExplorerScreen.tsx FicheProScreen.tsx Booking1Screen.tsx ... LiveStatusScreen.tsx ReservationsScreen.tsx AlertesScreen.tsx ClientProfilScreen.tsx"
        ]
      },
      "acceptanceCriteria": [
        "All 11 client screen files exist and are non-empty",
        "Booking5Screen (confirmation) calls `createBookingUrl` and uses `window.location.href` for redirect",
        "No `setTimeout` used to simulate payment",
        "No Stripe references",
        "No `100vh` CSS values",
        "Layout uses `flex flex-col` with fixed inset-0, scroll zone uses `flex-1 overflow-y-auto`, CTA button uses `flex-shrink-0`"
      ]
    },
    {
      "id": "REQ-8",
      "text": "Deliver all pro screens: `ProDashboardScreen.tsx`, `ProRadarScreen.tsx`, `ProWalletScreen.tsx`, `ProBusinessScreen.tsx` (5 tabs: profile, services, tarifs, payment, gallery), `SubscriptionModal.tsx` (calls `createSubscriptionUrl` from `lib/payrexx.ts`, redirects to Payrexx TWINT), `SuccessScreen.tsx`. No Stripe, no emoji.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-2"
        ],
        "quotes": [
          "screens/pro/ ProDashboardScreen.tsx ProRadarScreen.tsx ProWalletScreen.tsx ProBusinessScreen.tsx SubscriptionModal.tsx SuccessScreen.tsx"
        ]
      },
      "acceptanceCriteria": [
        "All 6 pro screen files exist",
        "SubscriptionModal calls `createSubscriptionUrl` and redirects via `window.location.href`",
        "SubscriptionModal amount is 1990 CHF cents (19.90 CHF), TWINT only",
        "ProBusinessScreen has 5 tabs: profile, services, tarifs, payment/IBAN, gallery",
        "No emoji in any pro screen file"
      ]
    },
    {
      "id": "REQ-9",
      "text": "Deliver all admin screens: `AdminLoginScreen.tsx`, `AdminDashboardScreen.tsx`, `AdminProsScreen.tsx`, `AdminBookingsScreen.tsx`, `AdminRevenusScreen.tsx`. Admin login must use credentials stored in localStorage (set during first-run SetupScreen). No emoji.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-2"
        ],
        "quotes": [
          "screens/admin/ AdminLoginScreen.tsx AdminDashboardScreen.tsx AdminProsScreen.tsx AdminBookingsScreen.tsx AdminRevenusScreen.tsx"
        ]
      },
      "acceptanceCriteria": [
        "All 5 admin screen files exist",
        "AdminLoginScreen validates against credentials stored in localStorage by SetupScreen",
        "AdminDashboardScreen shows real canister data via `lib/api.ts`",
        "No emoji in any admin screen"
      ]
    },
    {
      "id": "REQ-10",
      "text": "Implement `SetupScreen` (first-run configuration screen). Display it before `AdminLoginScreen` if any of `VITE_PAYREXX_INSTANCE`, `VITE_PAYREXX_SECRET`, or `VITE_WORKER_URL` are empty OR if no admin credentials exist in localStorage. The screen must have: title 'NEXUS Initial Configuration' (Inter 800 28px), Payrexx section (Instance input placeholder 'nexus', Secret API input type=password), Twilio section (Worker URL input placeholder 'https://...'), Admin section (email, password, confirm password). 'Initialize NEXUS' CTA button with gold background and `#050507` text saves all values to localStorage and to the canister admin config via `lib/api.ts`.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-2"
        ],
        "quotes": [
          "Écran de configuration admin au premier démarrage. Si variables env vides → afficher SetupScreen avant AdminLogin"
        ]
      },
      "acceptanceCriteria": [
        "SetupScreen renders when env vars are empty or admin credentials absent from localStorage",
        "All inputs have onChange handlers",
        "Password and confirm password fields validate they match before saving",
        "'Initialize NEXUS' button is gold background with #050507 text",
        "On submit, values are persisted to localStorage AND written to canister via `lib/api.ts`",
        "After successful setup, navigates to AdminLoginScreen"
      ]
    },
    {
      "id": "REQ-11",
      "text": "Create `backend/main.mo` (full Motoko actor) and `backend/Types.mo` implementing: user auth (Internet Identity principal), pro profiles (status, location, category, services, gallery, avis), explorer query (active pros + flash pros), 5-step booking lifecycle (pending → confirmed → in_progress → completed → cancelled), wallet (CHF balance, transfer with 30s cooldown), notifications, admin functions (validate pro, list all bookings, revenue stats), 48h escrow heartbeat, and admin config storage (SetupScreen values). Include the commented-out `PAYREXX_INTEGRATION` stub as specified.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-2"
        ],
        "quotes": [
          "backend/ main.mo Types.mo"
        ]
      },
      "acceptanceCriteria": [
        "`Types.mo` exports all shared types (UserProfile, ProProfile, Booking, Notification, AdminConfig, etc.)",
        "`main.mo` imports `Types.mo` and implements all CRUD operations",
        "Heartbeat cancels bookings not confirmed within 48h",
        "Admin config (Payrexx instance, Worker URL) is stored in stable memory",
        "`main.mo` compiles with `dfx build` without errors",
        "PAYREXX_INTEGRATION comment block is present in `main.mo`"
      ]
    },
    {
      "id": "REQ-12",
      "text": "Create `.env.production` file at the project root with the template: `VITE_PAYREXX_INSTANCE=nexus`, `VITE_PAYREXX_SECRET=your_secret`, `VITE_WORKER_URL=https://nexus-sms.workers.dev`, `VITE_ICP_CANISTER_ID=your_canister_id`, `VITE_ICP_HOST=https://ic0.app`. Placeholder values must be clearly marked as requiring replacement.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-2"
        ],
        "quotes": [
          "Fichier .env.production"
        ]
      },
      "acceptanceCriteria": [
        "`.env.production` file exists at project root",
        "All 5 env vars are present",
        "No real secrets are committed — placeholder values used"
      ]
    },
    {
      "id": "REQ-13",
      "text": "Enforce absolute layout rules across ALL screens: `flex flex-col fixed inset-0` on root container, scrollable content zone uses `flex-1 overflow-y-auto`, CTA buttons use `flex-shrink-0` anchored at bottom, tab bars use `flex-shrink-0` (never `position: fixed`). Remove all `100vh` CSS. Font is Inter exclusively. Palette CSS variables defined in `globals.css`. Gold background always pairs with `color: #050507`. Zero emojis anywhere in source code.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-2"
        ],
        "quotes": [
          "Navigation useState uniquement",
          "Layout flex column fixed inset 0",
          "Scroll zone flex 1 overflow-y auto",
          "Bouton CTA flex-shrink 0 ancré bas",
          "Tab bar flex-shrink 0 jamais fixed",
          "Font Inter uniquement",
          "Fond gold → texte #050507 TOUJOURS"
        ]
      },
      "acceptanceCriteria": [
        "No `100vh` string found in any `.tsx` or `.css` file",
        "No `position: fixed` on any tab bar component",
        "No emoji characters (unicode or literal) in any source file",
        "All gold/amber background elements have `color: #050507`",
        "Google Fonts Inter is loaded (already in index.html) and applied via CSS variable"
      ]
    }
  ],
  "constraints": [
    "TWINT via Payrexx is the ONLY payment method — remove all Stripe and Revolut references",
    "Zero emojis in any source file (components, screens, backend, utils)",
    "No demo mode, no simulated data, no setTimeout fake payment flows in production code",
    "Navigation must use useState only — no React Router",
    "Layout must use flex column with fixed inset-0, never 100vh",
    "Payrexx and Twilio credentials must never be exposed in frontend source — use env vars and Cloudflare Worker proxy",
    "Font must be Inter exclusively",
    "frontend/src/hooks/useInternetIdentity.ts, frontend/src/hooks/useActor.ts, frontend/src/main.tsx, and frontend/src/components/ui are immutable — do not edit them",
    "All images must have onError handlers",
    "All buttons must have onClick handlers",
    "All inputs must have onChange handlers"
  ],
  "nonGoals": [
    "Stripe integration of any kind",
    "Revolut integration",
    "SMS credentials on the frontend",
    "React Router or any URL-based routing library",
    "Real-time WebSocket features",
    "Twilio called directly from canister (stub only, commented out)",
    "Payrexx called directly from canister in current build (stub only, commented out)",
    "Any emoji characters"
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}